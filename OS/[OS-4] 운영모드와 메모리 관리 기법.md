#OS-4 운영모드와 메모리 관리 기법

x86와 x86-64 프로세스에서 지원하는 메모리 관리 기법은 크게 2가지이다.<br>

* 세그먼테이션(Segmentation)
* 페이징(Paging)

둘다 모두 메모리를 나누는 것이고 차이점은 세그먼테이션은 원하는크기로 짤라 쓰는 방식이고, 페이징 같은경우에는 정해진 크기로 짤라져 있는 조각을 모아 원하는 크기로 관리하는 방식이다.<br>

*세그먼테이션*은 세그먼트의 시작주소 or 디스크립터라고 불리는 자료구조의 위치를 설정 해야된다.

*페이징*은 CR3 레지스터에 페이지 디렉터리라 불리는 자료구조의 물리주소를 설정해야지 사용 가능하다.

###리얼 모드의 메모리 관리 방식

최대 1MB까지 주소공간을 사용하며, 세그먼테이션만 지원한다.
세그먼트 크기는 64k로 고정이며, 세그먼트 시작 주소는 코드나 메모리에 접근할 때 기준 어드레스로 사용된다.

#####물리주소 계산법
	(세그먼트 레지스터) * 16 + (범용 레지스터) = (물리주소)

세그먼트 레지스터에 16를 곱하여 범용레지스터를 더하게 되면, 최대 1MB주소까지 접근 가능하게 된다.


###보호 모드의 메모리 관리 방식

보호 모드는 세그먼테이션과 페이징을 모두 지원한다.<br>
리얼모드의 세그먼테이션보다 많은 기능을 제공합니다.<br> 
세그먼트 레지스터에 세그먼트의 기준 주소를 직접 설정하는 대신 디스크럽터 자료구조의 위치를 설정하는 방식으로 변경 되었다.<br>
세그먼트 레지스터 명칭도 세그먼트 셀렉터로 변경 되었다.

세그먼트에 대한 정보를 나타내는 디스크럽터를 *세그먼트 디스크럽터*라고 한다.

세그먼트 디스크럽터에는 시작어드레스,크기,권한,타입 등의 정보가 있다.

![Imgur](http://i.imgur.com/Ge2UUBnm.png)

DPL(Descriptor Privilege Level)은 해당 세그먼트에 접근하기 위한 최소한의 권한을 나타내며, 0~3 사이 값을 가진다. 숫자가 작을수록 권한이 높다. 세그먼트에 접근할때 CPL이 적어도 디스크럽터에 설정된 권한과 같거나 높아야(낮아야) 된다. 안그러면 예외 처리 된다.

세그먼트 디스크립터는 GDT(Global Descriptor Table)라고 불리는 곳에 모여 있다. GDT는 연속된 디스크럽터의 집합이고, 최대 812개의 디스크럽터를 포함 할 수 있는 테이블 형태의 자료구조 이다.

GDT도 메모리상에 위치하는 자료구조라서 프로세서가 GDT 위치를 직접 알려줘야된다. GDT 위치관련 레지스터는 *GDTR* 이다. 

GDTR는 16bit GDT 크기 필드와 32bit 기준주소 필드로 구성된 자료구조의 물리 주소를 넘겨 받는다. 프로세서는 이값을 저장했다가 세그먼트 셀렉터를 통해 어드레스 접근시  GDT의 위치를 찾는데 참조한다.

#####물리주소 계산법
	(세그먼트 레지스터) * 16 + (범용 레지스터) = (물리주소)
	
**기준주소+범용레지스터 > 세그먼트의 크기**일 경우 프로세서는 세그먼트의 접근 권한을 위반한 경우와 마찬가지로 예외 처리로 오류가 발생한다.

페이징을 사용하지 않으면 선형주소는 물리주소와 1:1 대응한다.<br>
보통 사용하더라도 1:1로 대응하도록 설정한다.

#####선형주소와 물리주소가 1:1대응 할때 이점

 - OS메모리관리 기능을 작고 가볍게 유지가능하다.
 - 메모리 구조가 직관적이라 디버깅이 편하다.



